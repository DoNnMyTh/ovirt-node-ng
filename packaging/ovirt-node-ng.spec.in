
%global	_node_image_dir /usr/share/%{name}/image/
%global	_node_image_file %{_node_image_dir}/%{name}-%{version}-%{release}.squashfs.img
%global	_node_tools_dir /usr/share/%{name}/tools/
%global _node_stream ovirt-node-ng

%global with_image @WITH_IMAGE@

# Hardcode the dist to el7, because this is what the image contains
%global dist .el7

# Disable compression, because the image is already compressed
%define _source_payload w0.gzdio
%define _binary_payload w0.gzdio

Name:       ovirt-node-ng
Epoch:      1
Version:    @PACKAGE_RPM_VERSION@
Release:    @PACKAGE_RPM_RELEASE@%{?dist}%{?extra_release}
License:    GPLv2
Summary:    oVirt Node Next

URL:        http://www.ovirt.org/
Source0:    %{name}-@PACKAGE_VERSION@.tar.gz
Source1:    @IMAGENAME@.squashfs.img
BuildArch:  noarch

BuildRequires: autoconf
BuildRequires: automake

%description
This package provides some tooling around building oVirt Node Next.
Currently the main package is empty.

%if 0%{?with_image}
%package image
Summary: oVirt Node Next Image

%description image
This package contains the prebuild oVirt Node image.

%package image-update
Summary:    oVirt Node Next Image Update
Requires:   ovirt-node-ng-image
Requires:   imgbased

Obsoletes:  ovirt-node-ng-image-update-placeholder < %{epoch}:%{version}-%{release}
Provides:  ovirt-node-ng-image-update-placeholder = %{epoch}:%{version}-%{release}

%description image-update
This package will install the oVirt Node Image update to a host where
imgbased is used.
%endif

%package docs
Summary:     Documentation for %{name}

%description docs
Subpackage for docs related to %{name}

%package tools
Summary:     Tools for %{name}

%description tools
Subpackage for tools related to %{name}

%prep
%setup -q -n %{name}-@PACKAGE_VERSION@

%build
%configure
make %{?_smp_mflags}

%install
%make_install

%if 0%{?with_image}
# Install the image
/usr/bin/install -d %{buildroot}/%{_node_image_dir}
/usr/bin/install -m 644 %{SOURCE1} %{buildroot}/%{_node_image_file}

%post image-update
imgbase --debug update --format liveimg %{_node_image_file}

%files image
%dir %{_node_image_dir}
%{_node_image_file}
%endif

%files tools
%dir %{_node_tools_dir}
%{_node_tools_dir}/*
%{_bindir}/create-node-installation-iso

%files docs
%{_docdir}/%{name}/*

%changelog
* Mon Jan 25 2016 Douglas Schilling Landgraf <dougsland@redhat.com>
- Initial build
